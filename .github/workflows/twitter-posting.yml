name: "X: Core daily posts (8a/2p/8p ET)"

on:
  schedule:
    # Post 3 times daily:
    # - 8:00 AM ET (12:00 PM UTC) - Morning preview
    # - 2:00 PM ET (6:00 PM UTC) - Afternoon update
    # - 8:00 PM ET (12:00 AM UTC next day) - Evening recap
    - cron: '0 12 * * *'  # 8 AM ET
    - cron: '0 18 * * *'  # 2 PM ET
    - cron: '0 0 * * *'   # 8 PM ET
  workflow_dispatch:
    inputs:
      post_type:
        description: 'Type of post to create'
        required: true
        type: choice
        options:
          - morning_preview
          - afternoon_update
          - evening_recap

env:
  PYTHON_VERSION: '3.11'

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Determine post type
        id: post-type
        run: |
          HOUR=$(date -u +%H)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.post_type }}" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "12" ]; then
            echo "type=slate_summary" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "18" ]; then
            echo "type=afternoon_update" >> $GITHUB_OUTPUT
          else
            echo "type=evening_recap" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tweepy
          echo "üì¶ Dependencies installed"

      - name: Read predictions data
        id: read-data
        run: |
          echo "üìä Reading todaysPredictions.json..."
          if [ -f web/src/data/todaysPredictions.json ]; then
            echo "data_exists=true" >> $GITHUB_OUTPUT
          else
            echo "data_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Test post generation (dry run)
        if: steps.read-data.outputs.data_exists == 'true'
        run: |
          echo "üß™ Testing post generation..."
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai \
            --dry-run

      - name: Post to X/Twitter
        if: steps.read-data.outputs.data_exists == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWEET_CONTEXT_LABEL: "Core-${{ github.run_number }}"
        run: |
          # Check if Twitter credentials are configured
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "‚ö†Ô∏è  Twitter API credentials not configured."
            echo "üìù Running in dry-run mode only."
            echo ""
            echo "To enable posting, add these secrets to your GitHub repository:"
            echo "  Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - TWITTER_API_KEY"
            echo "  - TWITTER_API_SECRET"
            echo "  - TWITTER_ACCESS_TOKEN"
            echo "  - TWITTER_ACCESS_SECRET"
            echo "  - TWITTER_BEARER_TOKEN (optional)"
            exit 0
          fi

          # Post using the Python script
          echo "üì± Posting to X/Twitter..."
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai

      - name: Summary
        run: |
          echo "‚úÖ Twitter posting workflow complete!"
          echo "üïê Post type: ${{ steps.post-type.outputs.type }}"
