name: X: High-frequency daily posts (6 slots)

on:
  schedule:
    # Morning Preview - 8:00 AM ET (12:00 UTC)
    - cron: '0 12 * * *'
    # Micro-Insight - 10:30 AM ET (14:30 UTC)
    - cron: '30 14 * * *'
    # Afternoon Update - 2:00 PM ET (18:00 UTC)
    - cron: '0 18 * * *'
    # Game of the Night - 5:00 PM ET (21:00 UTC)
    - cron: '0 21 * * *'
    # Upset Watch - 6:30 PM ET (22:30 UTC)
    - cron: '30 22 * * *'
    # Evening Recap - 8:00 PM ET (00:00 UTC next day)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      post_type:
        description: 'Type of post to create'
        required: true
        type: choice
        options:
          - morning_preview
          - afternoon_update
          - evening_recap
          - micro_insights
          - game_of_night
          - upset_watch
          - fun_fact

env:
  PYTHON_VERSION: '3.11'

jobs:
  post-to-twitter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Determine post type
        id: post-type
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.post_type }}" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "12" ] && [ "$MINUTE" = "00" ]; then
            echo "type=morning_preview" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "14" ] && [ "$MINUTE" = "30" ]; then
            echo "type=micro_insights" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "18" ] && [ "$MINUTE" = "00" ]; then
            echo "type=afternoon_update" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "21" ] && [ "$MINUTE" = "00" ]; then
            echo "type=game_of_night" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "22" ] && [ "$MINUTE" = "30" ]; then
            echo "type=upset_watch" >> $GITHUB_OUTPUT
          else
            echo "type=evening_recap" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tweepy
          echo "üì¶ Dependencies installed"

      - name: Refresh predictions (fallback pull)
        run: |
          echo "üåê Fetching latest predictions from live API..."
          mkdir -p web/src/data
          curl -fsSL --location https://www.puckcast.ai/api/predictions -o web/src/data/todaysPredictions.json
          echo "‚úÖ Pulled latest predictions payload"

      - name: Validate predictions freshness
        run: |
          python - <<'PYCODE'
          import json
          from datetime import datetime, timezone
          from zoneinfo import ZoneInfo
          import sys

          path = "web/src/data/todaysPredictions.json"
          with open(path) as f:
              data = json.load(f)
          generated_at = data.get("generatedAt")
          if not generated_at:
              raise SystemExit("‚ùå No generatedAt in predictions payload")
          generated_dt = datetime.fromisoformat(generated_at.replace("Z", "+00:00"))
          now_utc = datetime.now(timezone.utc)
          now_et = now_utc.astimezone(ZoneInfo("America/New_York"))
          gen_et = generated_dt.astimezone(ZoneInfo("America/New_York"))
          if (now_et.date() != gen_et.date()) or (now_utc - generated_dt).total_seconds() > 60 * 60 * 24:
              raise SystemExit(f"‚ùå Predictions stale: generated {generated_dt.isoformat()}Z, today is {now_et.date()} ET")
          print(f"‚úÖ Predictions fresh: generated {generated_dt.isoformat()}Z (ET {gen_et.isoformat()})")
          PYCODE

      - name: Read predictions data
        id: read-data
        run: |
          echo "üìä Reading todaysPredictions.json..."
          if [ -f web/src/data/todaysPredictions.json ]; then
            echo "data_exists=true" >> $GITHUB_OUTPUT
          else
            echo "data_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Test post generation (dry run)
        if: steps.read-data.outputs.data_exists == 'true'
        run: |
          echo "üß™ Testing post generation..."
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai \
            --dry-run

      - name: Post to X/Twitter
        if: steps.read-data.outputs.data_exists == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "‚ö†Ô∏è  Twitter API credentials not configured."
            echo "üìù Running in dry-run mode only."
            exit 0
          fi

          echo "üì± Posting to X/Twitter..."
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai

      - name: Summary
        run: |
          echo "‚úÖ Twitter posting workflow complete!"
          echo "üïê Post type: ${{ steps.post-type.outputs.type }}"
