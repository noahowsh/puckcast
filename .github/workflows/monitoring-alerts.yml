# =============================================================================
# Monitoring & Alerts Workflow
# =============================================================================
# Monitors workflow health and sends notifications on failures:
# - Watches "Daily Predictions Update" and "Scheduled Data Refresh" workflows
# - Runs health checks every 6 hours
# - Sends alerts to configured channels (Discord/Slack) on failures
#
# Configure ALERT_WEBHOOK_URL secret for notifications.
# =============================================================================

name: Monitoring & Alerts

on:
  workflow_run:
    workflows: ["Daily Predictions Update", "Scheduled Data Refresh (Granular)"]
    types:
      - completed
  schedule:
    # Run health check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check workflow status
        id: workflow-check
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_NAME="${WORKFLOW_NAME:-Scheduled check}"

          # Check if workflow succeeded
          if [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=${WORKFLOW_NAME} failed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=${WORKFLOW_NAME} succeeded" >> $GITHUB_OUTPUT
          fi

      - name: Check data freshness
        id: data-check
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          data_dir = Path("web/src/data")

          # Define freshness thresholds for each data type (in hours)
          data_files = {
              "todaysPredictions.json": {"max_age": 14, "name": "Predictions"},  # Refreshes 2x daily
              "currentStandings.json": {"max_age": 26, "name": "Standings"},     # Refreshes 1x daily
              "goaliePulse.json": {"max_age": 14, "name": "Goalie Pulse"},       # Refreshes 2x daily
              "injuries.json": {"max_age": 10, "name": "Injuries"},              # Refreshes 3x daily
              "starting_goalies.json": {"max_age": 10, "name": "Starting Goalies"},  # Refreshes 3x daily
              "powerIndex.json": {"max_age": 26, "name": "Power Index"},         # Refreshes 1x daily
              "socialMetrics.json": {"max_age": 26, "name": "Social Metrics"},   # Refreshes 1x daily
          }

          alerts = []
          fresh_count = 0

          for filename, config in data_files.items():
              file_path = data_dir / filename
              if not file_path.exists():
                  alerts.append(f"‚ùå {config['name']}: file not found")
                  continue

              try:
                  with open(file_path) as f:
                      data = json.load(f)

                  # Look for timestamp in common field names
                  timestamp_str = data.get("generatedAt") or data.get("lastUpdated") or data.get("timestamp")
                  if not timestamp_str:
                      alerts.append(f"‚ö†Ô∏è {config['name']}: missing timestamp")
                      continue

                  timestamp = datetime.fromisoformat(timestamp_str.replace("Z", "+00:00"))
                  if timestamp.tzinfo is None:
                      timestamp = timestamp.replace(tzinfo=timezone.utc)

                  age_hours = (datetime.now(timezone.utc) - timestamp).total_seconds() / 3600

                  if age_hours > config["max_age"]:
                      alerts.append(f"‚ö†Ô∏è {config['name']}: {age_hours:.1f}h old (threshold: {config['max_age']}h)")
                  else:
                      print(f"‚úÖ {config['name']}: fresh ({age_hours:.1f}h old)")
                      fresh_count += 1
              except json.JSONDecodeError:
                  alerts.append(f"‚ùå {config['name']}: invalid JSON")
              except Exception as e:
                  alerts.append(f"‚ùå {config['name']}: error - {e}")

          print(f"\nChecked {len(data_files)} data files: {fresh_count} fresh, {len(alerts)} issues")

          if alerts:
              print("\n".join(alerts))
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=stale\n")
                  f.write(f"message={'|'.join(alerts)}\n")
          else:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=fresh\n")
                  f.write("message=All data is fresh\n")
          EOF

      - name: Check model performance anomalies
        id: performance-check
        run: |
          python << 'EOF'
          import json
          import os
          from pathlib import Path

          data_dir = Path("web/src/data")
          predictions_file = data_dir / "todaysPredictions.json"

          alerts = []

          if predictions_file.exists():
              with open(predictions_file) as f:
                  data = json.load(f)

              games = data.get("games", [])

              if not games:
                  alerts.append("‚ö†Ô∏è No games in predictions")
              else:
                  # Check for anomalies
                  high_conf_count = sum(1 for g in games if g.get("confidenceGrade", "C")[0] in ["A", "B"])
                  high_conf_pct = high_conf_count / len(games) * 100

                  # Alert if too many or too few high confidence picks
                  if high_conf_pct > 80:
                      alerts.append(f"‚ö†Ô∏è Unusually high confidence: {high_conf_pct:.0f}% of games are A/B grade")
                  elif high_conf_pct < 20:
                      alerts.append(f"‚ö†Ô∏è Unusually low confidence: only {high_conf_pct:.0f}% of games are A/B grade")

                  # Check for extreme probabilities
                  extreme_probs = [g for g in games if g.get("homeWinProb", 0.5) > 0.9 or g.get("homeWinProb", 0.5) < 0.1]
                  if len(extreme_probs) > len(games) * 0.3:
                      alerts.append(f"‚ö†Ô∏è {len(extreme_probs)} games have extreme probabilities (>90% or <10%)")

          if alerts:
              print("\n".join(alerts))
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=anomaly\n")
                  f.write(f"message={'|'.join(alerts)}\n")
          else:
              print("‚úÖ No performance anomalies detected")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("status=normal\n")
                  f.write("message=Performance looks normal\n")
          EOF

      - name: Send Slack notification
        if: steps.data-check.outputs.status == 'stale' || steps.performance-check.outputs.status == 'anomaly' || steps.workflow-check.outputs.status == 'failed'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è Slack webhook not configured. Skipping notification."
            exit 0
          fi

          # Build message
          MESSAGE="üèí *Puckcast Alert*\n"
          MESSAGE+="‚Ä¢ Workflow: ${{ steps.workflow-check.outputs.message }}\n"
          MESSAGE+="‚Ä¢ Data: ${{ steps.data-check.outputs.message }}\n"
          MESSAGE+="‚Ä¢ Performance: ${{ steps.performance-check.outputs.message }}"

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$MESSAGE\"}"

          echo "üì± Sent Slack notification"

      - name: Send Discord notification
        if: steps.data-check.outputs.status == 'stale' || steps.performance-check.outputs.status == 'anomaly' || steps.workflow-check.outputs.status == 'failed'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è Discord webhook not configured. Skipping notification."
            exit 0
          fi

          # Build embed message
          MESSAGE="üèí **Puckcast Alert**\\n"
          MESSAGE+="‚Ä¢ Workflow: ${{ steps.workflow-check.outputs.message }}\\n"
          MESSAGE+="‚Ä¢ Data: ${{ steps.data-check.outputs.message }}\\n"
          MESSAGE+="‚Ä¢ Performance: ${{ steps.performance-check.outputs.message }}"

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"content\":\"$MESSAGE\"}"

          echo "üì± Sent Discord notification"

      - name: Create GitHub issue on failure
        if: steps.workflow-check.outputs.status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Daily Predictions Workflow Failed';
            const body = `## Alert Details

            - **Workflow**: ${{ steps.workflow-check.outputs.message }}
            - **Data Status**: ${{ steps.data-check.outputs.message }}
            - **Performance**: ${{ steps.performance-check.outputs.message }}
            - **Time**: ${new Date().toISOString()}

            ## Action Required

            Please investigate the workflow logs and fix any issues.

            [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation', 'high-priority']
            });

      - name: Summary
        run: |
          echo "‚úÖ Health check complete"
          echo "üìä Status Summary:"
          echo "  - Workflow: ${{ steps.workflow-check.outputs.status }}"
          echo "  - Data: ${{ steps.data-check.outputs.status }}"
          echo "  - Performance: ${{ steps.performance-check.outputs.status }}"
