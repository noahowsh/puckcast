name: X: Daily posts (4 slots)

on:
  schedule:
    # Morning slate (8:00 AM ET / 13:00 UTC during DST; adjust seasonally if needed)
    - cron: "0 13 * * *"
    # Team highlight (2:30 PM ET / 19:30 UTC during DST)
    - cron: "30 19 * * *"
    # Results recap (5:30 PM ET / 22:30 UTC during DST)
    - cron: "30 22 * * *"
    # Tomorrow tease (9:30 PM ET / 02:30 UTC next day during DST)
    - cron: "30 2 * * *"
  workflow_dispatch:
    inputs:
      post_type:
        description: "Force a specific post type"
        required: true
        type: choice
        options:
          - morning_slate
          - team_highlight
          - results_recap
          - tomorrow_tease

env:
  PYTHON_VERSION: "3.11"

concurrency:
  group: twitter-daily
  cancel-in-progress: false

jobs:
  post-to-x:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt tweepy

      - name: Determine post type
        id: post-type
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.post_type }}" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "13" ] && [ "$MINUTE" = "00" ]; then
            echo "type=morning_slate" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "19" ] && [ "$MINUTE" = "30" ]; then
            echo "type=team_highlight" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "22" ] && [ "$MINUTE" = "30" ]; then
            echo "type=results_recap" >> $GITHUB_OUTPUT
          else
            echo "type=tomorrow_tease" >> $GITHUB_OUTPUT
          fi

      - name: Refresh predictions payload
        run: |
          set -e
          echo "üåê Fetching latest predictions from live API (fallback to local run if needed)..."
          mkdir -p web/src/data
          if curl -fsSL --location https://www.puckcast.ai/api/predictions -o web/src/data/todaysPredictions.json; then
            echo "‚úÖ Pulled latest predictions payload"
          else
            echo "‚ö†Ô∏è Live API fetch failed; generating locally with predict_full.py..."
            python predict_full.py
          fi
          if [ ! -f web/src/data/todaysPredictions.json ]; then
            echo "‚ùå No predictions payload available after refresh"
            exit 1
          fi

      - name: Validate predictions freshness
        run: |
          python - <<'PYCODE'
          import json
          from datetime import datetime, timezone
          from zoneinfo import ZoneInfo
          path = "web/src/data/todaysPredictions.json"
          data = json.load(open(path))
          gen = data.get("generatedAt")
          if not gen:
            raise SystemExit("‚ùå No generatedAt in predictions payload")
          dt = datetime.fromisoformat(gen.replace("Z", "+00:00"))
          now_utc = datetime.now(timezone.utc)
          now_et = now_utc.astimezone(ZoneInfo("America/New_York"))
          gen_et = dt.astimezone(ZoneInfo("America/New_York"))
          if (now_et.date() != gen_et.date()) or (now_utc - dt).total_seconds() > 60*60*24:
            raise SystemExit(f"‚ùå Predictions stale: generated {dt.isoformat()}Z, today is {now_et.date()} ET")
          print(f"‚úÖ Predictions fresh: generated {dt.isoformat()}Z (ET {gen_et.isoformat()})")
          PYCODE

      - name: Dry-run post content
        run: |
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai \
            --dry-run

      - name: Post to X/Twitter
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "‚ö†Ô∏è Twitter API credentials not configured. Skipping post."
            exit 0
          fi
          echo "üì± Posting to X/Twitter..."
          python scripts/post_to_twitter.py \
            --post-type ${{ steps.post-type.outputs.type }} \
            --site-url https://puckcast.ai

      - name: Summary
        run: |
          echo "‚úÖ Twitter post completed"
          echo "üïê Post type: ${{ steps.post-type.outputs.type }}"
